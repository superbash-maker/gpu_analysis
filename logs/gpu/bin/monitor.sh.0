#!/bin/bash

LOGROOT=/mnt/lustre/logs/gpu 
HOSTNAME=$(hostname)

#; echo $HOSTNAME >> /mnt/lustre//logs/gpu/${HOSTNAME}_test

LOGDIR=$LOGROOT/${HOSTNAME}

#TIMESTAMP=$(date "+YmD H:M")
#TIMESTAMP=$(date "+\%Y\%m\%d \%H:\%M"); 
TIMESTAMP=$(date "+%Y%m%d %H:%M"); 

LOGFILE=${LOGDIR}/$TIMESTAMP


# UTILIZATION, ECC, TEMPERATURE, POWER, CLOCK,
#                                    COMPUTE, PIDS, PERFORMANCE, SUPPORTED_CLOCKS,
#                                    PAGE_RETIREMENT, ACCOUNTING, ENCODER_STATS, FBC_STATS
#                                Flags can be combined with comma e.g. ECC,POWER.
#                                Sampling data with max/min/avg is also returned 
#                                for POWER, UTILIZATION and CLOCK display types.



COUNT=$(nvidia-smi -L | wc -l  );

for  ((i=0; i<$COUNT; i++)); do 
  echo -n "$TIMESTAMP, $HOSTNAME, $i, " 
  nvidia-smi -i $i \
	--query-gpu=pci.bus_id,temperature.gpu,utilization.gpu,utilization.memory --format=csv | tr -d "%" | tail -1 
done

